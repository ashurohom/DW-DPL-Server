<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Wizard Form View -->
<record id="view_stock_valuation_report_wizard_form" model="ir.ui.view">
    <field name="name">stock.valuation.report.wizard.form</field>
    <field name="model">stock.valuation.report.wizard</field>
    <field name="arch" type="xml">
        <form string="Stock Valuation Report">

            <!-- FILTERS -->
            <group>
                <group>
                    <field name="date_from"/>
                    <field name="date_to"/>
                    <field name="company_id" groups="base.group_multi_company"/>
                </group>
                <group>
                    <field name="product_ids" widget="many2many_tags"/>
                    <field name="categ_ids" widget="many2many_tags"/>
                </group>
            </group>

            <!-- REPORT RESULT -->
            <notebook>
                <page string="Report Lines">
                    <field name="report_line_ids" nolabel="1">
                        <tree create="0" edit="0">
                            <field name="date"/>
                            <field name="reference"/>
                            <field name="product_id"/>
                            <field name="company_id"/>
                            <field name="quantity"/>
                            <field name="uom_id"/>
                            <!-- <field name="value" widget="monetary"/>
                            <field name="currency_id" invisible="1"/> -->
                        </tree>
                    </field>
                </page>
            </notebook>

            <!-- FOOTER -->
            <footer>
                <button name="action_generate_report"
                        string="View Report"
                        type="object"
                        class="btn-primary"/>

                <button name="action_print_report"
                        string="Print PDF"
                        type="object"
                        class="btn-secondary"/>

                <button string="Cancel"
                        class="btn-secondary"
                        special="cancel"/>
            </footer>

        </form>
    </field>
</record>

    <!-- Wizard Action -->
    <record id="action_stock_valuation_report_wizard" model="ir.actions.act_window">
        <field name="name">Stock Valuation Report</field>
        <field name="res_model">stock.valuation.report.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="binding_model_id" ref="stock.model_stock_move"/>
    </record>

    <!-- Menu Item -->
    <menuitem
        id="menu_stock_valuation_report"
        name="Stock Valuation Report"
        parent="stock.menu_warehouse_report"
        action="action_stock_valuation_report_wizard"
        sequence="50"/>


    <!-- PDF Report Template -->
<template id="report_stock_valuation_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.basic_layout">
                    <div class="page">
                        <h2>Stock Valuation Report</h2>
                        <div class="row mt-4 mb-4">
                            <div class="col-6">
                                <strong>Date From:</strong> <span t-esc="o.date_from"/>
                            </div>
                            <div class="col-6">
                                <strong>Date To:</strong> <span t-esc="o.date_to"/>
                            </div>
                        </div>

                        <t t-set="product_data" t-value="o._get_report_data()"/>
                        
                        <t t-foreach="product_data.values()" t-as="product_group">
                            <h4 class="mt-4">
                                <span t-esc="product_group['product'].name"/>
                                (<span t-esc="'%.2f' % product_group['total_qty']"/>)
                                <span class="float-right">
                                    Total: <span t-esc="product_group['total_value']" 
                                            t-options="{'widget': 'monetary', 'display_currency': o.company_id.currency_id}"/>
                                </span>
                            </h4>
                            
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr style="background-color: #7C7BAD; color: white;">
                                        <th>Date</th>
                                        <th>Reference</th>
                                        <th>Product</th>
                                        <th>Company</th>
                                        <th class="text-right">Moved Quantity</th>
                                        <th>Unit of Measure</th>
                                        <!-- <th class="text-right">Total Value</th> -->
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="product_group['moves']" t-as="move">
                                        <tr>
                                            <td><span t-esc="move['date'].strftime('%m/%d/%Y %H:%M:%S')"/></td>
                                            <td><span t-esc="move['reference']"/></td>
                                            <td><span t-esc="move['product']"/></td>
                                            <td><span t-esc="move['company']"/></td>
                                            <td class="text-right"><span t-esc="'%.2f' % move['quantity']"/></td>
                                            <td><span t-esc="move['uom']"/></td>
                                            <!-- <td class="text-right">
                                                <span t-esc="move['value']"
                                                    t-options="{'widget': 'monetary', 'display_currency': o.company_id.currency_id}"/>
                                            </td> -->
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </t>
                        <!-- <t t-set="grand_total_value" t-value="sum(p['total_value'] for p in product_data.values())"/>
                        <div class="row mt-4">
                            <div class="col-12 text-right">
                                <h4>
                                    <strong>Grand Total: </strong>
                                    <span t-esc="grand_total_value" 
                                       t-options="{'widget': 'monetary', 'display_currency': o.company_id.currency_id}"/>
                                </h4>
                            </div>
                        </div> -->
                    </div>
                </t>
            </t>
        </t>
    </template>

    <!-- Report Action -->
    <record id="action_report_stock_valuation" model="ir.actions.report">
        <field name="name">Stock Valuation Report</field>
        <field name="model">stock.valuation.report.wizard</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">all_reports_full.report_stock_valuation_document</field>
        <field name="report_file">all_reports_full.report_stock_valuation_document</field>
        <field name="binding_model_id" ref="model_stock_valuation_report_wizard"/>
        <field name="binding_type">report</field>
        <field name="print_report_name">'Stock_Valuation_%s_%s' % (object.date_from, object.date_to)</field>
    </record>

</odoo>
